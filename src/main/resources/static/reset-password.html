<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>비밀번호 재설정</title>
  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#f5f7fb; }
    .wrap { max-width:520px; margin:70px auto; background:#fff; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.08); padding:26px; }
    h1 { margin:0 0 8px; font-size:22px; }
    p { margin:0 0 18px; color:#666; font-size:14px; line-height:1.4; }
    label { display:block; font-size:13px; color:#333; margin:12px 0 6px; }
    input { width:100%; box-sizing:border-box; padding:12px 12px; border:1px solid #ddd; border-radius:12px; outline:none; }
    button { width:100%; margin-top:14px; padding:12px 14px; border:0; border-radius:12px; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .msg { margin-top:12px; font-size:13px; }
    .ok { color:#0f766e; }
    .err { color:#b91c1c; }
    .row { display:flex; gap:10px; margin-top:12px; }
    .row a { flex:1; text-align:center; padding:10px 12px; border-radius:12px; background:#eef2ff; text-decoration:none; color:#1f3a8a; font-weight:600; }
    .hint { font-size:12px; color:#777; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>비밀번호 재설정</h1>
    <p>새 비밀번호를 입력해 변경하세요.</p>

    <div id="tokenInfo" class="hint"></div>

    <label for="pw">새 비밀번호</label>
    <input id="pw" type="password" placeholder="6자 이상" />

    <label for="pw2">새 비밀번호 확인</label>
    <input id="pw2" type="password" placeholder="동일하게 입력" />

    <button id="btn">비밀번호 변경</button>
    <div id="msg" class="msg"></div>

    <div class="row">
      <a href="/login.html">로그인으로</a>
      <a href="/index.html">메인으로</a>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const token = params.get("token");

  const tokenInfo = document.getElementById("tokenInfo");
  const pw = document.getElementById("pw");
  const pw2 = document.getElementById("pw2");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");

  if (!token) {
    tokenInfo.textContent = "토큰이 없습니다. 메일의 링크로 다시 접속하세요.";
    btn.disabled = true;
  } else {
    tokenInfo.textContent = "토큰 확인됨";
  }

  btn.addEventListener("click", async () => {
    msg.textContent = "";
    msg.className = "msg";

    const a = pw.value.trim();
    const b = pw2.value.trim();

    if (a.length < 6) {
      msg.textContent = "비밀번호는 최소 6자 이상이어야 합니다.";
      msg.classList.add("err");
      return;
    }
    if (a !== b) {
      msg.textContent = "비밀번호가 서로 다릅니다.";
      msg.classList.add("err");
      return;
    }

    btn.disabled = true;
    btn.textContent = "변경 중...";

    try {
      const res = await fetch("/api/auth/reset-password", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ token, newPassword: a })
      });

      const text = await res.text();
      if (!res.ok) {
        msg.textContent = text || "변경 실패";
        msg.classList.add("err");
        return;
      }

      msg.textContent = text || "비밀번호가 변경되었습니다. 로그인 해주세요.";
      msg.classList.add("ok");

      setTimeout(() => location.href = "/login.html", 1000);

    } catch (e) {
      msg.textContent = "서버 연결 오류";
      msg.classList.add("err");
    } finally {
      btn.disabled = false;
      btn.textContent = "비밀번호 변경";
    }
  });
</script>
</body>
</html>
